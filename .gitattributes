from datetime import datetime
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, ConversationHandler
from telegram import KeyboardButton, ReplyKeyboardMarkup


TOKEN = '5338479753:AAFzPCrocDj05i_nAAnU5JVMpmVj61LiUjc'
print("Bot started")
updater = Updater(TOKEN)


def start(update, context):
    chat = update.effective_chat
    buttons = [[KeyboardButton('/make_a_note')]]
    context.bot.send_message(chat_id=chat.id, text="""Hi there! 
    \nI can show you chenges of currency rate during the year.
    \n let's start!""", reply_markup=ReplyKeyboardMarkup(buttons))


def cancel(update):
    update.message.reply_text(
        'Name Conversation cancelled by user. Bye. Send /set_name to start again')
    return ConversationHandler.END


def date_and_time():
    current_date = datetime.now.strftime("%m.%d.%Y")
    return current_date

def functional(update, context):
    mode = update.message.text
    if mode == '/make_a_note':
        addnote(update, context)


def saver(new_note):
    try:
        with open("notes.txt", 'r') as f:
            data = f.read()
        with open("notes.txt", 'w') as f:
            f.write(data + "\n"+"-"+new_note)
    except FileNotFoundError:
        with open("notes.txt", 'w') as f:
            f.write("-"+new_note)
                   

def addnote(update, context):
    chat = update.effective_chat
    context.bot.send_message(chat_id=chat.id, text="""
    okay, write down a note!)""")
    new_note = update.message.text
    saver(new_note) 
    context.bot.send_message(chat_id=chat.id, text="""
    well done!""")


disp = updater.dispatcher


_handlers = {}

_handlers['start'] = CommandHandler('start', start)

_handlers['make_a_note'] = ConversationHandler(
    entry_points=[CommandHandler('start', start)],
    states={
        "note": [MessageHandler(Filters.text, addnote)]
    },
    fallbacks=[CommandHandler('cancel', cancel)]
)


for name, _handler in _handlers.items():
    print(f'Adding handler {name}')
    disp.add_handler(_handler)


updater.start_polling()
updater.idle()
